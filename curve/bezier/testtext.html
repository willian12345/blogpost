<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    body {
      margin: 0;
        background-color: ivory;
    }
    #canvas {
        border:1px solid green;
    }
  </style>
</head>
<body>
  
    <canvas id="canvas" width=800 height=800></canvas>
    <script>
    // 获取canvas和context
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const ctrlPoints = [
      {x: 120, y: 160 }, 
      {x:  35, y: 200 }, 
      {x: 220, y: 260 }, 
      {x: 180, y:  40 },
    ];
    const x0 = ctrlPoints[0].x;
    const x1 = ctrlPoints[1].x;
    const x2 = ctrlPoints[2].x;
    const x3 = ctrlPoints[3].x;
    const y0 = ctrlPoints[0].y;
    const y1 = ctrlPoints[1].y;
    const y2 = ctrlPoints[2].y;
    const y3 = ctrlPoints[3].y;
    function evalBez(poly, t) {
        // 起点，控制点1，控制点2，终点 计算出 x 坐标
        // x = A (1-t)^3 +3 B t (1-t)^2 + 3 C t^2 (1-t) + D t^3
        var x = poly[0] * (1 - t) * (1 - t) * (1 - t) + 3 * poly[1] * t * (1 - t) * (1 - t) + 3 * poly[2] * t * t * (1 - t) + poly[3] * t * t * t;
        return x;
    }
    const getTextPoint = () => {
      const px = [x0,x1,x2,x3];
      const py = [y0,y1,y2,y3];
      const point = []
      for (var i = 1; i <= 20; ++i) {
            var t = i / 20;
            const x = evalBez(px, t);
            const y = evalBez(py, t);
            point.push({x, y})
        }
      return point;
    }
    const draw = () => {
      
      const A = x3 - 3 * x2 + 3 * x1 - x0
      const B = 3 * x2 - 6 * x1 + 3 * x0
      const C = 3 * x1 - 3 * x0
      const D = x0

      const E = y3 - 3 * y2 + 3 * y1 - y0
      const F = 3 * y2 - 6 * y1 + 3 * y0
      const G = 3 * y1 - 3 * y0
      const H = y0;
      const textPoint = getTextPoint();
      ctx.strokeStyle = "#f00";
      ctx.beginPath();
      ctx.moveTo(x0, y0);
      for(let t=0; t<1; t+=0.02){
        // calculate spline point for parameter t
        let Sx = A * Math.pow(t, 3) + B * Math.pow(t, 2) + C * t + D 
        let Sy = E * Math.pow(t, 3) + F * Math.pow(t, 2) + G * t + H 
        ctx.lineTo(Sx, Sy);

        // calculate the tangent vector for the point        
        let Tx = 3 * A * Math.pow(t, 2) + 2 * B * Math.pow(t, 2) + C 
        let Ty = 3 * E * Math.pow(t, 2) + 2 * F * Math.pow(t, 2) + G 
        // rotate 90 or 270 degrees to make it a perpendicular
        let Px =   Tx
        let Py = Ty
        let magnitude = Math.sqrt(Px*Px + Py*Py)
        Px = Px / magnitude
        Py = Py / magnitude
        // Px *= 10;
        // Py *= 10;
        console.log(Px,Py)
        ctx.fillText("w",Sx, Sy);
        // ctx.fillRect(Sx+Px, Sy+Py, 1, 1);
      }

      // for (let i =0; i < textPoint.length; i++)
      // {
      //     const pt = textPoint[i];
      //     let textX = pt.x;
      //     let textY = pt.y;
          
      //     // normalize the x coordinate into the parameterized value
      //     // with a domain between 0 and 1.
      //     let t =  textX / 6000;  
            
      //     // calculate spline point for parameter t
      //     let Sx = A * Math.pow(t, 3) + B * Math.pow(t, 2) + C * t + D 
      //     let Sy = E * Math.pow(t, 3) + F * Math.pow(t, 2) + G * t + H 
              
      //     // calculate the tangent vector for the point        
      //     let Tx = 3 * A * Math.pow(t, 2) + 2 * B * Math.pow(t, 2) + C 
      //     let Ty = 3 * E * Math.pow(t, 2) + 2 * F * Math.pow(t, 2) + G 
      //     // rotate 90 or 270 degrees to make it a perpendicular
      //     let Px =   Ty
      //     let Py = - Tx
          
      //     // normalize the perpendicular into a unit vector
      //     let magnitude = Math.sqrt(Px*Px + Py*Py)
      //     Px = Px / magnitude
      //     Py = Py / magnitude
          
      //     // assume that input text point y coord is the "height" or 
      //     // distance from the spline.  Multiply the perpendicular vector 
      //     // with y. it becomes the new magnitude of the vector.
      //     Px *= textY;
      //     Py *= textY;
          
      //     // translate the spline point using the resultant vector
      //     let finalX = Px + Sx
      //     let finalY = Py + Sy
          
      //     // I wish it were this easy, actually need 
      //     // to create a new path.
      //     ctx.lineTo(Sx, Sy);
          
      //     // textPath.PathPoints[i] = new PointF(finalX, finalY);
      // }
      ctx.stroke()
    }
    draw();
    </script>
</body>
</html>